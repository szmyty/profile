# Dashboard Cards

This document describes the SVG dashboard cards generated by the profile automation system.

## Overview

The system generates five distinct dashboard cards, each displaying different personal metrics. All cards share a consistent dark theme and visual language.

## Card Types

### Location Card

**File**: `location/location-card.svg`  
**Dimensions**: 480√ó400 pixels  
**Schedule**: Daily at 6 AM UTC  
**Workflow**: `build-profile.yml` (Phase 2: Fetch Location, Phase 4: Generate Card)

Displays the user's location with an embedded static map from OpenStreetMap.

**Features**:
- Static map image (embedded as base64)
- Location name and coordinates
- Automatic geocoding from GitHub profile

**Data Source**:
- GitHub API for user location
- Nominatim for geocoding
- OpenStreetMap for static map tiles

---

### Weather Card

**File**: `weather/weather-today.svg`  
**Dimensions**: 480√ó230 pixels  
**Schedule**: Daily at 7 AM UTC  
**Workflow**: `build-profile.yml` (Phase 2: Fetch Weather, Phase 4: Generate Card)

Shows current weather conditions and a 3-day forecast.

**Features**:
- Current temperature with weather emoji
- Weather condition description
- High/low temperatures
- 3-day forecast with icons
- Dynamic gradient based on weather condition

**Data Source**:
- Open-Meteo API (no API key required)
- WMO weather code mapping for conditions

**Weather Code Categories**:
| Codes | Condition | Emoji |
|-------|-----------|-------|
| 0 | Clear sky | ‚òÄÔ∏è |
| 1-3 | Partly cloudy | üå§Ô∏è |
| 45-48 | Fog | üå´Ô∏è |
| 51-67 | Rain/Drizzle | üåßÔ∏è |
| 71-77 | Snow | ‚ùÑÔ∏è |
| 80-99 | Thunderstorm | ‚õàÔ∏è |

---

### SoundCloud Card

**File**: `assets/soundcloud-card.svg`  
**Dimensions**: 480√ó144 pixels  
**Schedule**: Every 6 hours  
**Workflow**: `build-profile.yml` (Phase 2: Fetch SoundCloud, Phase 4: Generate Card)

Displays the latest track from a SoundCloud profile.

**Features**:
- Track artwork (embedded as base64)
- Track title and artist
- Duration and play count
- SoundCloud branding with orange accent
- Clickable link to track

**Data Source**:
- SoundCloud public API
- Artwork from track metadata

---

### Health Dashboard

**File**: `oura/health_dashboard.svg`  
**Dimensions**: 480√ó365 pixels  
**Schedule**: Every 6 hours  
**Workflow**: `build-profile.yml` (Phase 2: Fetch Oura, Phase 4: Generate Card)

Comprehensive health metrics dashboard from Oura Ring data.

**Features**:
- Three main score panels:
  - Sleep Score (blue gradient)
  - Readiness Score (green gradient)
  - Activity Score (pink gradient)
- Heart rate sparkline with current BPM
- HRV (Heart Rate Variability) display
- Body metrics (temperature deviation, weight, BMI)
- Update timestamp

**Score Panel Layout**:
```
+------------------+------------------+------------------+
|   üí§ Sleep       |   ‚ö° Readiness    |   üèÉ Activity    |
|      85          |       78         |        72        |
| 7h 23m duration  | Body temp +0.2¬∞  |  8,432 steps    |
| 89% efficiency   | Avg HR 62        |  1,234 cal      |
+------------------+------------------+------------------+
```

**Data Source**:
- Oura API v2 (requires PAT token)
- Aggregated daily summaries

---

### Mood Dashboard

**File**: `oura/mood_dashboard.svg`  
**Dimensions**: 480√ó250 pixels  
**Schedule**: Every 6 hours  
**Workflow**: `build-profile.yml` (Phase 2: Fetch Oura, Phase 4: Generate Card)

Displays computed mood state based on Oura health metrics.

**Features**:
- Dynamic mood icon (emoji-based)
- Mood category with description
- Contributing factors:
  - Sleep quality assessment
  - Recovery status
  - Energy level
  - Stress indicators
- Mood score (0-100)
- Dynamic gradient based on mood category

**Mood Categories**:
| Category | Score Range | Gradient |
|----------|-------------|----------|
| Excellent | 85-100 | Green to Teal |
| Good | 70-84 | Blue to Cyan |
| Fair | 50-69 | Yellow to Orange |
| Low | 0-49 | Red to Orange |

**Mood Computation**:
The mood engine (`scripts/oura_mood_engine.py`) computes the mood score as a weighted average:
- Sleep score (30%)
- Readiness score (30%)
- Activity score (15%)
- HRV (10%)
- Temperature deviation (10%)
- Resting HR inverted (5%) ‚Äî calculated as `(100 - resting_hr) * 0.05`, so lower heart rate contributes more positively to the score

---

## Visual Consistency

### Shared Elements

All cards include:
1. **Background gradient**: Dark gradient from top-left to bottom-right
2. **Border**: Subtle accent-colored stroke at 30% opacity
3. **Decorative accent**: 4px vertical bar on the right side
4. **Staleness badge**: Top-right corner badge showing "Updated: X ago" (see below)
5. **Border radius**: 12px rounded corners

### Data Staleness Indicators

All cards include a staleness badge in the top-right corner that shows when the data was last updated:

**Fresh Data (<24 hours old)**:
- Text: "Updated: X ago" (e.g., "just now", "2h ago", "23h ago")
- Color: Muted text (`#4a5568`)
- No icon

**Stale Data (‚â•24 hours old)**:
- Text: "‚ö†Ô∏è Updated: X ago" (e.g., "‚ö†Ô∏è Updated: 2d ago")
- Color: Warning/error red (`#ff6b6b`)
- Icon: ‚ö†Ô∏è warning triangle

This provides immediate visual feedback about data freshness and helps identify when workflows may have failed or been skipped.

### Color Usage

| Element | Color |
|---------|-------|
| Background | `#1a1a2e` ‚Üí `#16213e` |
| Primary text | `#ffffff` |
| Secondary text | `#8892b0` |
| Accent/highlights | `#64ffda` |
| Muted text | `#4a5568` |

### Typography

- **Headers**: 14-18px, white
- **Body text**: 10-12px, white or secondary
- **Labels**: 9-10px, muted
- **Scores**: 24-36px, white with glow filter

## Card Configuration

Cards are configured in `config/theme.json`:

```json
{
  "cards": {
    "widths": {
      "soundcloud": 480,
      "weather": 480,
      "mood": 480,
      "health_dashboard": 480,
      "location": 480
    },
    "heights": {
      "soundcloud": 144,
      "weather": 230,
      "mood": 250,
      "health_dashboard": 365,
      "location": 400
    }
  }
}
```

## Error Handling and Fallback Mode

All card generators implement robust error handling with automatic fallback:

### Fallback Mechanism

When card generation fails (e.g., API errors, missing data, network issues):
1. If a valid SVG already exists at the output path, it is **preserved**
2. The error is logged but does not cause workflow failure
3. The existing card continues to be displayed (with its staleness badge)

This ensures cards never disappear from the README, maintaining a consistent user experience even when APIs are temporarily unavailable.

### Data Unavailable State

The staleness badge serves as the primary indicator of data issues:
- Cards that couldn't be updated continue showing with their previous data
- The staleness badge shows how long ago the data was last successfully updated
- The ‚ö†Ô∏è warning icon appears when data is >24 hours old

### Implementation

Card generators should use the `generate_card_with_fallback` utility:

```python
from lib.utils import generate_card_with_fallback

success = generate_card_with_fallback(
    card_type="weather",
    output_path="weather/weather-today.svg",
    json_path="weather/weather.json",
    schema_name="weather",
    generator_func=generate_weather_svg,
    description="Weather metadata file",
)
```

Or implement manual fallback handling using `fallback_exists()` and `handle_error_with_fallback()`.

## Adding New Cards

To add a new card type:

1. **Create fetch script**: `scripts/fetch-newcard.sh`
2. **Create generator**: `scripts/generate-newcard.py`
3. **Add to theme**: Define dimensions in `config/theme.json`
4. **Create workflow**: `.github/workflows/newcard.yml`
5. **Add README marker**: `<!-- NEWCARD-CARD:START --><!-- NEWCARD-CARD:END -->`

Example generator using CardBase:

```python
#!/usr/bin/env python3
from lib.card_base import CardBase

class NewCard(CardBase):
    def __init__(self):
        super().__init__("newcard")
    
    def generate_content(self) -> str:
        font_family = self.get_typography("font_family")
        return f'''
          <text x="20" y="40" 
                font-family="{font_family}" 
                fill="{self.get_color('text', 'primary')}">
            New Card Content
          </text>
        '''

if __name__ == "__main__":
    card = NewCard()
    
    # Generate SVG with staleness badge (automatically handles stale data indicators)
    # Pass the ISO 8601 timestamp from your data source
    svg = card.generate_svg()
    
    # Add staleness badge to the SVG
    updated_at = "2025-12-03T19:45:45Z"  # ISO 8601 timestamp from data
    staleness_badge = card.build_staleness_badge(updated_at)
    
    # Insert badge before closing </svg> tag
    svg = svg.replace('</svg>', f'{staleness_badge}\n</svg>')
    
    card.write_svg("output.svg", svg)
```

**Note**: For non-CardBase implementations, use the helper functions directly:

```python
from lib.utils import format_time_since, is_data_stale, escape_xml

updated_at = "2025-12-03T19:45:45Z"
time_since = format_time_since(updated_at)
is_stale = is_data_stale(updated_at, stale_threshold_hours=24)

# Build badge with appropriate styling
if is_stale:
    badge_color = "#ff6b6b"  # Warning color
    badge_icon = "‚ö†Ô∏è "
else:
    badge_color = "#4a5568"  # Muted color
    badge_icon = ""

staleness_badge = f'''
  <g transform="translate(470, 10)">
    <text x="0" y="12" fill="{badge_color}" text-anchor="end">
      {badge_icon}Updated: {escape_xml(time_since)}
    </text>
  </g>'''
```

## SVG Optimization

All generated SVGs are optimized using SVGO before committing:

```bash
svgo card.svg -o card.svg
```

This typically reduces file size by 10-30% without visual changes.
