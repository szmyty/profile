name: Build Profile ‚Äî Modular Composite-Action Architecture

on:
  push:
    branches:
      - main
      - master
  schedule:
    # Run once per day at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

concurrency:
  group: profile-update
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  # ===================================================================
  # Setup Job
  # ===================================================================
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
  
  # ===================================================================
  # Fetch Jobs
  # ===================================================================
  fetch-developer:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.fetch.outputs.skip }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üåê Fetch developer statistics
        id: fetch
        uses: ./.github/actions/fetch-developer
        with:
          github-token: ${{ github.token }}
          username: ${{ github.repository_owner }}
  
  fetch-location:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.fetch.outputs.skip }}
      location: ${{ steps.fetch.outputs.location }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üìç Fetch location data
        id: fetch
        uses: ./.github/actions/fetch-location
        with:
          github-token: ${{ github.token }}
          username: ${{ github.repository_owner }}
          mapbox-token: ${{ secrets.MAPBOX_TOKEN }}
  
  fetch-weather:
    needs: fetch-location
    runs-on: ubuntu-latest
    if: needs.fetch-location.outputs.skip != 'true'
    outputs:
      skip: ${{ steps.fetch.outputs.skip }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üå¶Ô∏è Fetch weather data
        id: fetch
        uses: ./.github/actions/fetch-weather
        with:
          github-token: ${{ github.token }}
          username: ${{ github.repository_owner }}
  
  fetch-soundcloud:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.fetch.outputs.skip }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üéµ Fetch SoundCloud data
        id: fetch
        uses: ./.github/actions/fetch-soundcloud
        with:
          soundcloud-user: playfunction
  
  fetch-oura:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.fetch.outputs.skip }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üß¨ Fetch Oura health data
        id: fetch
        uses: ./.github/actions/fetch-oura
        with:
          oura-pat: ${{ secrets.OURA_PAT }}
  
  fetch-quote:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.fetch.outputs.skip }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: ‚ú® Fetch quote of the day
        id: fetch
        uses: ./.github/actions/fetch-quote
  
  # ===================================================================
  # Generation Jobs
  # ===================================================================
  generate-developer-dashboard:
    needs: fetch-developer
    runs-on: ubuntu-latest
    if: needs.fetch-developer.outputs.skip != 'true'
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üíª Generate developer dashboard
        uses: ./.github/actions/generate-developer-dashboard
  
  generate-quote-card:
    needs: fetch-quote
    runs-on: ubuntu-latest
    if: needs.fetch-quote.outputs.skip != 'true'
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: ‚ú® Generate quote card
        uses: ./.github/actions/generate-quote-card
  
  generate-weather-card:
    needs: fetch-weather
    runs-on: ubuntu-latest
    if: needs.fetch-weather.outputs.skip != 'true'
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üå¶Ô∏è Generate weather card
        uses: ./.github/actions/generate-weather-card
  
  generate-location-card:
    needs: fetch-location
    runs-on: ubuntu-latest
    if: needs.fetch-location.outputs.skip != 'true'
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üìç Generate location card
        uses: ./.github/actions/generate-location-card
  
  generate-soundcloud-card:
    needs: fetch-soundcloud
    runs-on: ubuntu-latest
    if: needs.fetch-soundcloud.outputs.skip != 'true'
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üéµ Generate SoundCloud card
        uses: ./.github/actions/generate-soundcloud-card
  
  generate-oura-dashboard:
    needs: fetch-oura
    runs-on: ubuntu-latest
    if: needs.fetch-oura.outputs.skip != 'true'
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üß¨ Generate Oura health dashboard
        uses: ./.github/actions/generate-oura-dashboard
  
  generate-oura-mood:
    needs: fetch-oura
    runs-on: ubuntu-latest
    if: needs.fetch-oura.outputs.skip != 'true'
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üß¨ Generate Oura mood dashboard
        uses: ./.github/actions/generate-oura-mood
  
  # ===================================================================
  # Post-Processing Jobs
  # ===================================================================
  optimize-svgs:
    needs:
      - generate-developer-dashboard
      - generate-quote-card
      - generate-weather-card
      - generate-location-card
      - generate-soundcloud-card
      - generate-oura-dashboard
      - generate-oura-mood
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üé® Optimize SVG files
        uses: ./.github/actions/optimize-svgs
  
  update-readme:
    needs: optimize-svgs
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üìù Update README
        uses: ./.github/actions/update-readme
  
  deploy-pages:
    needs: update-readme
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: ./.github/actions/deploy-pages
        continue-on-error: true
  
  # ===================================================================
  # Commit Changes
  # ===================================================================
  commit-changes:
    needs: deploy-pages
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üì§ Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all relevant files
          git add developer/stats.json developer/developer_dashboard.svg 2>/dev/null || true
          git add quotes/quote.json quotes/quote_card.svg 2>/dev/null || true
          git add weather/weather.json weather/weather-today.svg 2>/dev/null || true
          git add location/location.json location/location-map.png location/location-card.svg 2>/dev/null || true
          git add assets/metadata.json assets/soundcloud-card.svg assets/soundcloud-artwork.jpg 2>/dev/null || true
          git add oura/metrics.json oura/mood.json oura/health_snapshot.json oura/health_dashboard.svg oura/mood_dashboard.svg 2>/dev/null || true
          git add README.md 2>/dev/null || true
          
          # Add logs (always commit logs)
          git add logs/ 2>/dev/null || true
          
          # Add debug files if they exist
          git add developer/raw/*.json 2>/dev/null || true
          git add location/debug_*.txt 2>/dev/null || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            # Create a comprehensive commit message using a temporary file
            COMMIT_MSG_FILE=$(mktemp)
            echo "üîÑ Build profile ‚Äî Update all cards and data" > "$COMMIT_MSG_FILE"
            
            # Add specific details if available
            if [ -f "developer/stats.json" ]; then
              USERNAME=$(jq -r '.username // "N/A"' developer/stats.json)
              COMMITS=$(jq -r '.commit_activity.total_30_days // 0' developer/stats.json)
              echo "" >> "$COMMIT_MSG_FILE"
              echo "- Developer: ${USERNAME} (${COMMITS} commits in 30d)" >> "$COMMIT_MSG_FILE"
            fi
            
            if [ -f "oura/mood.json" ]; then
              MOOD=$(jq -r '.mood_name // "N/A"' oura/mood.json)
              SCORE=$(jq -r '.mood_score // 0' oura/mood.json)
              echo "- Health: ${MOOD} mood (${SCORE}/100)" >> "$COMMIT_MSG_FILE"
            fi
            
            if [ -f "weather/weather.json" ]; then
              LOCATION=$(jq -r '.location // "N/A"' weather/weather.json)
              echo "- Weather: ${LOCATION}" >> "$COMMIT_MSG_FILE"
            fi
            
            git commit -F "$COMMIT_MSG_FILE"
            rm -f "$COMMIT_MSG_FILE"
            git push
            echo "‚úÖ Changes committed and pushed successfully"
          fi
        continue-on-error: true
  
  # ===================================================================
  # Build Summary
  # ===================================================================
  build-summary:
    needs:
      - fetch-developer
      - fetch-quote
      - fetch-weather
      - fetch-location
      - fetch-soundcloud
      - fetch-oura
      - commit-changes
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üìä Build Summary
        run: |
          echo "=============================================="
          echo "  Build Profile Pipeline - Summary"
          echo "=============================================="
          echo ""
          echo "Data Fetch Status:"
          echo "  Developer Stats: ${{ needs.fetch-developer.outputs.skip != 'true' && '‚úÖ' || '‚ö†Ô∏è Skipped' }}"
          echo "  Quote of the Day: ${{ needs.fetch-quote.outputs.skip != 'true' && '‚úÖ' || '‚ö†Ô∏è Skipped' }}"
          echo "  Weather Data: ${{ needs.fetch-weather.outputs.skip != 'true' && '‚úÖ' || '‚ö†Ô∏è Skipped' }}"
          echo "  Location Data: ${{ needs.fetch-location.outputs.skip != 'true' && '‚úÖ' || '‚ö†Ô∏è Skipped' }}"
          echo "  SoundCloud Data: ${{ needs.fetch-soundcloud.outputs.skip != 'true' && '‚úÖ' || '‚ö†Ô∏è Skipped' }}"
          echo "  Oura Health Data: ${{ needs.fetch-oura.outputs.skip != 'true' && '‚úÖ' || '‚ö†Ô∏è Skipped' }}"
          echo ""
          echo "Generated Cards:"
          test -f developer/developer_dashboard.svg && echo "  ‚úÖ Developer Dashboard" || echo "  ‚ö†Ô∏è Developer Dashboard"
          test -f quotes/quote_card.svg && echo "  ‚úÖ Quote of the Day Card" || echo "  ‚ö†Ô∏è Quote of the Day Card"
          test -f weather/weather-today.svg && echo "  ‚úÖ Weather Card" || echo "  ‚ö†Ô∏è Weather Card"
          test -f location/location-card.svg && echo "  ‚úÖ Location Card" || echo "  ‚ö†Ô∏è Location Card"
          test -f assets/soundcloud-card.svg && echo "  ‚úÖ SoundCloud Card" || echo "  ‚ö†Ô∏è SoundCloud Card"
          test -f oura/health_dashboard.svg && echo "  ‚úÖ Oura Health Dashboard" || echo "  ‚ö†Ô∏è Oura Health Dashboard"
          test -f oura/mood_dashboard.svg && echo "  ‚úÖ Oura Mood Dashboard" || echo "  ‚ö†Ô∏è Oura Mood Dashboard"
          echo ""
          echo "Dashboard Status:"
          test -d dashboard-app/dist && echo "  ‚úÖ React Dashboard Built" || echo "  ‚ö†Ô∏è React Dashboard Not Built"
          echo ""
          echo "=============================================="
          echo "  Build Complete!"
          echo "=============================================="
