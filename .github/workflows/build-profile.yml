name: Build Profile ‚Äî Modular Composite-Action Architecture

on:
  push:
    branches:
      - main
      - master
  schedule:
    # Run once per day at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

concurrency:
  group: profile-update
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  # ===================================================================
  # Main Build Job - Fetch and Generate All Content
  # ===================================================================
  build-profile:
    runs-on: ubuntu-latest
    outputs:
      fetch-developer-skip: ${{ steps.fetch-developer.outputs.skip }}
      fetch-location-skip: ${{ steps.fetch-location.outputs.skip }}
      fetch-weather-skip: ${{ steps.fetch-weather.outputs.skip }}
      fetch-soundcloud-skip: ${{ steps.fetch-soundcloud.outputs.skip }}
      fetch-oura-skip: ${{ steps.fetch-oura.outputs.skip }}
      fetch-quote-skip: ${{ steps.fetch-quote.outputs.skip }}
    
    steps:
      # Setup Phase
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      # Fetch Phase
      - name: üåê Fetch developer statistics
        id: fetch-developer
        uses: ./.github/actions/fetch-developer
        with:
          github-token: ${{ github.token }}
          username: ${{ github.repository_owner }}
        continue-on-error: true
      
      - name: üìç Fetch location data
        id: fetch-location
        uses: ./.github/actions/fetch-location
        with:
          github-token: ${{ github.token }}
          username: ${{ github.repository_owner }}
          mapbox-token: ${{ secrets.MAPBOX_TOKEN }}
        continue-on-error: true
      
      - name: üå¶Ô∏è Fetch weather data
        id: fetch-weather
        if: steps.fetch-location.outputs.skip != 'true'
        uses: ./.github/actions/fetch-weather
        with:
          github-token: ${{ github.token }}
          username: ${{ github.repository_owner }}
        continue-on-error: true
      
      - name: üéµ Fetch SoundCloud data
        id: fetch-soundcloud
        uses: ./.github/actions/fetch-soundcloud
        with:
          soundcloud-user: playfunction
        continue-on-error: true
      
      - name: üß¨ Fetch Oura health data
        id: fetch-oura
        uses: ./.github/actions/fetch-oura
        with:
          oura-pat: ${{ secrets.OURA_PAT }}
        continue-on-error: true
      
      - name: ‚ú® Fetch quote of the day
        id: fetch-quote
        uses: ./.github/actions/fetch-quote
        continue-on-error: true
      
      # Validation Phase
      - name: ‚úÖ Validate JSON Data
        run: |
          echo "Validating JSON data files..."
          
          VALIDATION_FAILED=false
          
          # Validate all JSON files
          for json_file in developer/stats.json weather/weather.json location/location.json assets/metadata.json oura/metrics.json quotes/quote.json; do
            if [ -f "$json_file" ]; then
              if jq empty "$json_file" 2>/dev/null; then
                echo "‚úÖ $json_file is valid"
              else
                echo "‚ö†Ô∏è Warning: $json_file is invalid JSON"
                VALIDATION_FAILED=true
              fi
            else
              echo "‚ÑπÔ∏è $json_file does not exist (skipped)"
            fi
          done
          
          if [ "$VALIDATION_FAILED" = true ]; then
            echo "‚ö†Ô∏è Some JSON files failed validation, but continuing..."
          else
            echo "‚úÖ All JSON files validated successfully"
          fi
        continue-on-error: true
      
      # Generation Phase
      - name: üíª Generate developer dashboard
        if: steps.fetch-developer.outputs.skip != 'true'
        uses: ./.github/actions/generate-developer-dashboard
        continue-on-error: true
      
      - name: ‚ú® Generate quote card
        if: steps.fetch-quote.outputs.skip != 'true'
        uses: ./.github/actions/generate-quote-card
        continue-on-error: true
      
      - name: üå¶Ô∏è Generate weather card
        if: steps.fetch-weather.outputs.skip != 'true'
        uses: ./.github/actions/generate-weather-card
        continue-on-error: true
      
      - name: üìç Generate location card
        if: steps.fetch-location.outputs.skip != 'true'
        uses: ./.github/actions/generate-location-card
        continue-on-error: true
      
      - name: üéµ Generate SoundCloud card
        if: steps.fetch-soundcloud.outputs.skip != 'true'
        uses: ./.github/actions/generate-soundcloud-card
        continue-on-error: true
      
      - name: üß¨ Generate Oura health dashboard
        if: steps.fetch-oura.outputs.skip != 'true'
        uses: ./.github/actions/generate-oura-dashboard
        continue-on-error: true
      
      - name: üß¨ Generate Oura mood dashboard
        if: steps.fetch-oura.outputs.skip != 'true'
        uses: ./.github/actions/generate-oura-mood
        continue-on-error: true
      
      # Optimization Phase
      - name: üé® Optimize SVG files
        uses: ./.github/actions/optimize-svgs
        continue-on-error: true
      
      # Sanitization Phase
      - name: üßπ Sanitize all generated SVG files
        run: |
          echo "Sanitizing SVG files for GitHub compatibility..."
          profile-engine sanitize all
          echo "‚úÖ SVG sanitization complete"
        continue-on-error: false
      
      # Update README
      - name: üìù Update README
        uses: ./.github/actions/update-readme
        continue-on-error: true
      
      # Upload artifacts for the deploy job
      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4.4.3
        with:
          name: profile-data
          path: |
            developer/
            weather/
            location/
            assets/
            oura/
            quotes/
            README.md
            logs/
          retention-days: 1
  
  # ===================================================================
  # Deploy to GitHub Pages
  # ===================================================================
  deploy-pages:
    needs: build-profile
    runs-on: ubuntu-latest
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üîß Setup environment
        uses: ./.github/actions/setup
      
      - name: üì• Download build artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: profile-data
          path: .
      
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: ./.github/actions/deploy-pages
        continue-on-error: true
  
  # ===================================================================
  # Commit Changes
  # ===================================================================
  commit-changes:
    needs: build-profile
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üì• Download build artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: profile-data
          path: .
      
      - name: üì§ Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all relevant files
          git add developer/stats.json developer/developer_dashboard.svg 2>/dev/null || true
          git add quotes/quote.json quotes/quote_card.svg 2>/dev/null || true
          git add weather/weather.json weather/weather-today.svg 2>/dev/null || true
          git add location/location.json location/location-map.png location/location-card.svg 2>/dev/null || true
          git add assets/metadata.json assets/soundcloud-card.svg assets/soundcloud-artwork.jpg 2>/dev/null || true
          git add oura/metrics.json oura/mood.json oura/health_snapshot.json oura/health_dashboard.svg oura/mood_dashboard.svg 2>/dev/null || true
          git add README.md 2>/dev/null || true
          
          # Add logs (always commit logs)
          git add logs/ 2>/dev/null || true
          
          # Add debug files if they exist
          git add developer/raw/*.json 2>/dev/null || true
          git add location/debug_*.txt 2>/dev/null || true
          
          # Helper function for safe jq extraction
          safe_jq() {
            local file=$1
            local query=$2
            local default=$3
            jq -r "$query // \"$default\"" "$file" 2>/dev/null || echo "$default"
          }
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            # Create a comprehensive commit message using a temporary file
            COMMIT_MSG_FILE=$(mktemp)
            echo "üîÑ Build profile ‚Äî Update all cards and data" > "$COMMIT_MSG_FILE"
            
            # Add specific details if available
            if [ -f "developer/stats.json" ]; then
              USERNAME=$(safe_jq "developer/stats.json" ".username" "N/A")
              COMMITS=$(safe_jq "developer/stats.json" ".commit_activity.total_30_days" "0")
              echo "" >> "$COMMIT_MSG_FILE"
              echo "- Developer: ${USERNAME} (${COMMITS} commits in 30d)" >> "$COMMIT_MSG_FILE"
            fi
            
            if [ -f "oura/mood.json" ]; then
              MOOD=$(safe_jq "oura/mood.json" ".mood_name" "N/A")
              SCORE=$(safe_jq "oura/mood.json" ".mood_score" "0")
              echo "- Health: ${MOOD} mood (${SCORE}/100)" >> "$COMMIT_MSG_FILE"
            fi
            
            if [ -f "weather/weather.json" ]; then
              LOCATION=$(safe_jq "weather/weather.json" ".location" "N/A")
              echo "- Weather: ${LOCATION}" >> "$COMMIT_MSG_FILE"
            fi
            
            git commit -F "$COMMIT_MSG_FILE"
            rm -f "$COMMIT_MSG_FILE"
            git push
            echo "‚úÖ Changes committed and pushed successfully"
          fi
        continue-on-error: true
  
  # ===================================================================
  # Build Summary
  # ===================================================================
  build-summary:
    needs:
      - build-profile
      - deploy-pages
      - commit-changes
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: üì• Download build artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: profile-data
          path: .
        continue-on-error: true
      
      - name: üìä Build Summary
        run: |
          echo "=============================================="
          echo "  Build Profile Pipeline - Summary"
          echo "=============================================="
          echo ""
          
          # Helper function to display status
          show_status() {
            if [ "$1" = "success" ]; then
              echo "  ‚úÖ $2"
            else
              echo "  ‚ö†Ô∏è $2"
            fi
          }
          
          echo "Data Fetch Status:"
          show_status "${{ needs.build-profile.outputs.fetch-developer-skip != 'true' && 'success' || 'skip' }}" "Developer Stats"
          show_status "${{ needs.build-profile.outputs.fetch-quote-skip != 'true' && 'success' || 'skip' }}" "Quote of the Day"
          show_status "${{ needs.build-profile.outputs.fetch-weather-skip != 'true' && 'success' || 'skip' }}" "Weather Data"
          show_status "${{ needs.build-profile.outputs.fetch-location-skip != 'true' && 'success' || 'skip' }}" "Location Data"
          show_status "${{ needs.build-profile.outputs.fetch-soundcloud-skip != 'true' && 'success' || 'skip' }}" "SoundCloud Data"
          show_status "${{ needs.build-profile.outputs.fetch-oura-skip != 'true' && 'success' || 'skip' }}" "Oura Health Data"
          
          echo ""
          echo "Generated Cards:"
          for card in "developer/developer_dashboard.svg:Developer Dashboard" \
                      "quotes/quote_card.svg:Quote of the Day Card" \
                      "weather/weather-today.svg:Weather Card" \
                      "location/location-card.svg:Location Card" \
                      "assets/soundcloud-card.svg:SoundCloud Card" \
                      "oura/health_dashboard.svg:Oura Health Dashboard" \
                      "oura/mood_dashboard.svg:Oura Mood Dashboard"; do
            file="${card%%:*}"
            name="${card##*:}"
            test -f "$file" && show_status "success" "$name" || show_status "skip" "$name"
          done
          
          echo ""
          echo "Dashboard Status:"
          test -d dashboard-app/dist && show_status "success" "React Dashboard Built" || show_status "skip" "React Dashboard Not Built"
          
          echo ""
          echo "=============================================="
          echo "  Build Complete!"
          echo "=============================================="
