name: Parallel Data Fetch & Card Generation

on:
  schedule:
    # Run every 6 hours to match existing schedules
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - 'scripts/fetch-*.sh'
      - 'scripts/generate-*.py'
      - 'scripts/update-readme.py'
      - 'scripts/lib/**'
      - 'config/theme.json'
      - '.github/workflows/parallel-fetch.yml'

concurrency:
  group: profile-update
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  # Parallel job 1: Fetch Oura data
  fetch-oura:
    runs-on: ubuntu-latest
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          install-python-deps: 'false'

      - name: Fetch Oura metrics
        env:
          OURA_PAT: ${{ secrets.OURA_PAT }}
          OUTPUT_DIR: oura
        run: |
          mkdir -p oura logs/oura
          
          # Safe JSON write pattern: output to temp file first
          if ! scripts/fetch-oura.sh > oura/metrics.json.tmp 2>> logs/oura/oura.log; then
            echo "Error: Failed to fetch Oura data"
            rm -f oura/metrics.json.tmp
            exit 1
          fi
          
          # Validate the temp JSON file before moving
          if ! jq empty oura/metrics.json.tmp 2>/dev/null; then
            echo "Error: Invalid JSON in metrics file"
            rm -f oura/metrics.json.tmp
            exit 1
          fi
          
          # Move temp to final location (atomic operation)
          mv oura/metrics.json.tmp oura/metrics.json
          
          echo "Oura metrics fetched successfully"

      - name: Upload Oura data
        uses: actions/upload-artifact@v4
        with:
          name: oura-data
          path: oura/metrics.json
          retention-days: 1

  # Parallel job 2: Fetch Weather data
  fetch-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          install-python-deps: 'false'

      - name: Get GitHub profile location
        id: location
        run: |
          LOCATION=$(curl -sf "https://api.github.com/users/${{ github.repository_owner }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "User-Agent: GitHub-Profile-Weather-Card" | jq -r '.location // empty')
          
          if [ -z "$LOCATION" ]; then
            echo "Warning: No location found in GitHub profile"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "value=$LOCATION" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Found location: $LOCATION"
          fi

      - name: Fetch weather data
        if: steps.location.outputs.skip != 'true'
        env:
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_TOKEN: ${{ github.token }}
          OUTPUT_DIR: weather
        run: |
          mkdir -p weather logs/weather
          
          # Safe JSON write pattern: output to temp file first
          if ! scripts/fetch-weather.sh > weather/weather.json.tmp 2>> logs/weather/weather.log; then
            echo "Error: Failed to fetch weather data"
            rm -f weather/weather.json.tmp
            exit 1
          fi
          
          # Validate the temp JSON file before moving
          if ! jq empty weather/weather.json.tmp 2>/dev/null; then
            echo "Error: Invalid JSON in weather file"
            rm -f weather/weather.json.tmp
            exit 1
          fi
          
          # Move temp to final location (atomic operation)
          mv weather/weather.json.tmp weather/weather.json
          
          echo "Weather data fetched successfully"

      - name: Upload Weather data
        if: steps.location.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: weather-data
          path: weather/weather.json
          retention-days: 1

  # Parallel job 3: Fetch SoundCloud data
  fetch-soundcloud:
    runs-on: ubuntu-latest
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Install additional dependencies
        uses: ./.github/actions/pip-install
        with:
          packages: 'Pillow'

      - name: Fetch SoundCloud data
        env:
          SOUNDCLOUD_USER: playfunction
          OUTPUT_DIR: assets
        run: |
          mkdir -p assets logs/soundcloud
          
          # Safe JSON write pattern: output to temp file first
          if ! scripts/fetch-soundcloud.sh > assets/metadata.json.tmp 2>> logs/soundcloud/soundcloud.log; then
            echo "Error: Failed to fetch SoundCloud data"
            rm -f assets/metadata.json.tmp
            exit 1
          fi
          
          # Validate the temp JSON file before moving
          if ! jq empty assets/metadata.json.tmp 2>/dev/null; then
            echo "Error: Invalid JSON in metadata file"
            rm -f assets/metadata.json.tmp
            exit 1
          fi
          
          # Move temp to final location (atomic operation)
          mv assets/metadata.json.tmp assets/metadata.json

      - name: Upload SoundCloud data
        uses: actions/upload-artifact@v4
        with:
          name: soundcloud-data
          path: |
            assets/metadata.json
            assets/soundcloud-artwork.jpg
          retention-days: 1

  # Sequential job: Generate all cards after fetches complete
  generate-cards:
    runs-on: ubuntu-latest
    needs: [fetch-oura, fetch-weather, fetch-soundcloud]
    if: always() # Run even if some fetches fail
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Install Python dependencies
        uses: ./.github/actions/pip-install
        with:
          packages: 'Pillow'

      - name: Install npm dependencies
        run: |
          npm install -g svgo

      # Download all artifacts
      - name: Download Oura data
        uses: actions/download-artifact@v4
        with:
          name: oura-data
          path: oura
        continue-on-error: true

      - name: Download Weather data
        uses: actions/download-artifact@v4
        with:
          name: weather-data
          path: weather
        continue-on-error: true

      - name: Download SoundCloud data
        uses: actions/download-artifact@v4
        with:
          name: soundcloud-data
          path: assets
        continue-on-error: true

      # Generate Oura cards
      - name: Generate Oura cards
        if: hashFiles('oura/metrics.json') != ''
        run: |
          python scripts/generate-health-snapshot.py oura/metrics.json oura/health_snapshot.json
          python scripts/generate-health-dashboard.py oura/health_snapshot.json oura/health_dashboard.svg
          python scripts/oura-mood-engine.py oura/metrics.json oura/mood.json
          python scripts/generate-oura-mood-card.py oura/mood.json oura/metrics.json oura/mood_dashboard.svg

      # Generate Weather card
      - name: Generate Weather card
        if: hashFiles('weather/weather.json') != ''
        run: |
          python scripts/generate-weather-card.py weather/weather.json weather/weather-today.svg

      # Generate SoundCloud card
      - name: Generate SoundCloud card
        if: hashFiles('assets/metadata.json') != ''
        run: |
          python scripts/generate-card.py assets/metadata.json assets/soundcloud-artwork.jpg assets/soundcloud-card.svg

      # Optimize all SVGs in parallel
      - name: Optimize SVGs with SVGO
        run: |
          # Create optimized SVGO config for better optimization
          cat > /tmp/svgo.config.js << 'EOF'
          module.exports = {
            multipass: true,
            plugins: [
              {
                name: 'preset-default',
                params: {
                  overrides: {
                    cleanupIds: {
                      minify: true,
                      preserve: [],
                      preservePrefixes: [],
                      force: true
                    },
                    removeViewBox: false,
                    removeUselessDefs: true,
                    cleanupNumericValues: {
                      floatPrecision: 2
                    },
                    convertPathData: {
                      floatPrecision: 2,
                      transformPrecision: 5,
                      applyTransforms: true,
                      removeUseless: true,
                      straightCurves: true,
                      lineShorthands: true,
                      curveSmoothShorthands: true
                    }
                  }
                }
              },
              'removeXMLNS',
              'removeScriptElement',
              {
                name: 'convertStyleToAttrs',
                params: {
                  onlyMatchedOnce: false
                }
              }
            ]
          };
          EOF
          
          # Find and optimize all SVG files
          # Use null delimiter for safe handling of filenames with spaces/special chars
          find oura weather assets -name "*.svg" -type f -print0 2>/dev/null | while IFS= read -r -d '' svg; do
            if [ -f "$svg" ]; then
              ORIGINAL_SIZE=$(stat -c%s "$svg")
              if [ "$ORIGINAL_SIZE" -gt 0 ]; then
                svgo "$svg" -o "$svg" --config=/tmp/svgo.config.js --quiet
                OPTIMIZED_SIZE=$(stat -c%s "$svg")
                # Prevent division by zero
                if [ "$ORIGINAL_SIZE" -gt 0 ]; then
                  REDUCTION=$(( 100 - OPTIMIZED_SIZE * 100 / ORIGINAL_SIZE ))
                  echo "$(basename "$svg"): ${ORIGINAL_SIZE} â†’ ${OPTIMIZED_SIZE} bytes (${REDUCTION}% reduction)"
                fi
              fi
            fi
          done

      # Update README with all cards
      - name: Update README
        run: |
          if [ -f "oura/health_dashboard.svg" ]; then
            python scripts/update-readme.py \
              --marker OURA-HEALTH-CARD \
              --content "![Oura Health Dashboard](./oura/health_dashboard.svg)"
          fi
          
          if [ -f "oura/mood_dashboard.svg" ]; then
            python scripts/update-readme.py \
              --marker OURA-MOOD-CARD \
              --content "![Oura Mood Dashboard](./oura/mood_dashboard.svg)"
          fi
          
          if [ -f "weather/weather-today.svg" ]; then
            python scripts/update-readme.py \
              --marker WEATHER-CARD \
              --content "![Today's Weather](./weather/weather-today.svg)"
          fi
          
          if [ -f "assets/soundcloud-card.svg" ]; then
            PERMALINK_URL=$(jq -r '.permalink_url' assets/metadata.json)
            CARD_CONTENT="[![SoundCloud Latest Track](assets/soundcloud-card.svg)](${PERMALINK_URL})"
            python scripts/update-readme.py \
              --marker SOUNDCLOUD-CARD \
              --content "${CARD_CONTENT}"
          fi

      # Commit and push all changes
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all relevant files
          git add oura/*.json oura/*.svg weather/*.json weather/*.svg assets/*.json assets/*.svg assets/*.jpg README.md 2>/dev/null || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ”„ Update all cards (parallel fetch)"
            git push
          fi
