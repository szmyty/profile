name: 'Install Python Packages with Caching'
description: 'Install Python packages using pip with optimized caching based on package names'
inputs:
  packages:
    description: 'Space-separated list of Python packages to install (e.g., "Pillow jsonschema")'
    required: true
  cache-key-suffix:
    description: 'Optional suffix for cache key to allow multiple caches per workflow'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Get Python version
      id: python-version
      shell: bash
      run: |
        PYTHON_VERSION=$(python --version | cut -d' ' -f2)
        echo "version=${PYTHON_VERSION}" >> $GITHUB_OUTPUT
        echo "Python version: ${PYTHON_VERSION}"

    - name: Generate cache key from packages
      id: cache-key
      shell: bash
      run: |
        # Sort packages alphabetically for consistent cache keys
        # Use printf for safer handling of package names
        PACKAGES="${{ inputs.packages }}"
        SORTED_PACKAGES=$(printf '%s\n' $PACKAGES | sort | tr '\n' ' ' | xargs)
        
        # Create a hash of the package list for cache key
        PACKAGE_HASH=$(printf '%s' "$SORTED_PACKAGES" | sha256sum | cut -d' ' -f1 | cut -c1-8)
        
        # Construct cache key
        CACHE_KEY="pip-packages-${{ runner.os }}-py${{ steps.python-version.outputs.version }}-${PACKAGE_HASH}"
        if [ -n "${{ inputs.cache-key-suffix }}" ]; then
          CACHE_KEY="${CACHE_KEY}-${{ inputs.cache-key-suffix }}"
        fi
        
        echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
        echo "packages=${SORTED_PACKAGES}" >> $GITHUB_OUTPUT
        echo "Cache key: ${CACHE_KEY}"
        echo "Packages: ${SORTED_PACKAGES}"

    - name: Cache pip packages
      uses: actions/cache@v4
      id: pip-cache
      with:
        path: ~/.cache/pip
        key: ${{ steps.cache-key.outputs.key }}
        restore-keys: |
          pip-packages-${{ runner.os }}-py${{ steps.python-version.outputs.version }}-
          pip-packages-${{ runner.os }}-

    - name: Install packages
      shell: bash
      run: |
        if [ "${{ steps.pip-cache.outputs.cache-hit }}" = "true" ]; then
          echo "✓ Cache hit for packages: ${{ steps.cache-key.outputs.packages }}"
          echo "Installing from cache..."
        else
          echo "✗ Cache miss for packages: ${{ steps.cache-key.outputs.packages }}"
          echo "Installing and caching..."
        fi
        
        pip install ${{ steps.cache-key.outputs.packages }}
        
        # Show installed package versions for debugging
        # Use grep -F for fixed string matching (no regex interpretation)
        pip list | grep -F "$(printf '%s\n' ${{ steps.cache-key.outputs.packages }})" || true
